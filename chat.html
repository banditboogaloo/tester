<!DOCTYPE html>
<html>
<head>
<title>The Mandrill Chat</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <style>
    body {
      background-image: url('maze.gif');
	  background-repeat: repeat;
      color: #333;
      font-family: Arial, sans-serif;
      background-size: cover;
      margin: 0;
      padding: 20px;
    }

		ul {
			list-style-type: none;
			padding: 0;
			
			margin: 15px 0;
		}
		
		br {}
		
		li {
			list-style-type: none;
			padding: 0;
			
			margin: 15px 0;
		}

    .content {
      max-width: 800px;
      margin: 0 auto;
      background-color: rgba(255, 255, 255, 0.65); /* Adding a semi-transparent white background to the content area */
      padding: 20px;
    }

    h1 {
      color: #555;
      font-size: 24px;
      margin-bottom: 20px;
    }

    p {
      margin-bottom: 10px;
    }

    a {
      color: #007bff;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    #content-overlay {
      none;
    }
  </style>
</head>
<body>
  <div id="content-overlay">
    <div class="content">
      <h1>The Mandrill Chat</h1>
		
		
		<audio id="backgroundMusic" loop>
		<source src="https://fiallaspares.com/elepikchat/fundofesteem.mp3" type="audio/mpeg">
		Your browser does not support the audio element.
		</audio>	
        <hr>
		<script>
function setCookie(name, value, days) {
    const date = new Date();
    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
    const expires = "expires=" + date.toUTCString();
    document.cookie = name + "=" + value + ";" + expires + ";path=/";
}

function getCookie(name) {
    const decodedCookie = decodeURIComponent(document.cookie);
    const cookies = decodedCookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
            return cookie.substring(name.length + 1);
        }
    }
    return "";
}

function isUsernameLocked() {
    return !!getCookie('usernameLocked');
}

function addGuest() {
    const nameInput = document.getElementById('guestName');
    const usernameInput = document.getElementById('guestUsername');
    const name = nameInput.value;
    const username = usernameInput.value;

    if (!name || !username) {
        alert('Fill in both fields.');
        return;
    }

    fetch('https://guest.fiallaspares.com/api/addGuest', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `name=${encodeURIComponent(name)}&username=${encodeURIComponent(username)}`,
    })
    .then(response => {
        if (response.status === 429) {
            alert('noes... you spammed too much....');
            throw new Error('2 much spam');
        }
        if (!response.ok) {
            throw new Error('Network response was is not ok, cheer him up..');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            console.log(`Message sent with ID: ${data.guestId}`);
            nameInput.value = '';
            nameInput.focus();
            setCookie('usernameLocked', 'true', 30);
            setCookie('lockedUsernameValue', username, 30);
        } else {
            alert('failed 2 add message....');
        }
    })
    .catch(error => {
        console.error('error......', error.message);
        alert('failed to send messagez....');
    });
}

document.addEventListener('DOMContentLoaded', function () {
    const usernameInput = document.getElementById('guestUsername');
    if (isUsernameLocked()) {
        usernameInput.value = getCookie('lockedUsernameValue');
        usernameInput.disabled = true;
    }
});
</script>

		<br>
        <input type="text" id="guestUsername" name="guestUsername" placeholder="cooldude69"><br><br>
        <input type="text" id="guestName" name="guestName" placeholder="watz poppin my doods">
		<br>
        <button id="sendButton" onclick="addGuest()">Send Message</button>
        <div id="guestList">
            <ul id="guestListItems"></ul>
        </div>
    </center>

    <!-- Audio element for ding sound -->
    <audio id="dingSound">
        <source src="https://banditboogaloo.com/ding.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

 <script>
        let previousMessageCount = 0;
function getGuestList() {
    fetch('https://guest.fiallaspares.com/api/getGuests')
        .then(response => response.json())
        .then(data => {
            const guestListItems = document.getElementById('guestListItems');
            guestListItems.innerHTML = '';

            // Slice the data array to include only the last 10 elements
            const lastTenMessages = data.slice(-35);

            // Reverse the order of the array to display newest guests first
            lastTenMessages.reverse().forEach(guest => {
                const listItem = document.createElement('li');
                const messageBox = document.createElement('div'); // Create a div for message box
                messageBox.classList.add('message-box'); // Add class for styling

                // Check if the name contains ":troll:" or ":clueless:"
                if (guest.name.includes(':troll:') || guest.name.includes(':clueless:')) {
                    const trollParts = guest.name.split(':troll:');
                    trollParts.forEach((part, index) => {
                        const cluelessParts = part.split(':clueless:');
                        const messageContainer = document.createElement('div'); // Container for text and images
                        cluelessParts.forEach((cluelessPart, cluelessIndex) => {
                            // Append the text part
                            messageContainer.appendChild(document.createTextNode(cluelessPart));
                            // If it's not the last part, append the clueless image
                            if (cluelessIndex < cluelessParts.length - 1) {
                                const cluelessImage = document.createElement('img');
                                cluelessImage.src = 'https://fiallaspares.com/elepikchat/clueless.png';
                                cluelessImage.style.width = '25px'; // Set a fixed width for the image (adjust as needed)
                                cluelessImage.style.height = 'auto'; // Maintain aspect ratio
                                cluelessImage.style.verticalAlign = 'middle'; // Align the image vertically
                                messageContainer.appendChild(cluelessImage);
                            }
                        });
                        // If it's not the last part, append the troll image
                        if (index < trollParts.length - 1) {
                            const trollImage = document.createElement('img');
                            trollImage.src = 'https://fiallaspares.com/elepikchat/troll.png';
                            trollImage.style.width = '30px'; // Set a fixed width for the image (adjust as needed)
                            trollImage.style.height = 'auto'; // Maintain aspect ratio
                            trollImage.style.verticalAlign = 'middle'; // Align the image vertically
                            messageContainer.appendChild(trollImage);
                        }
                        // Append the container to the message box
                        messageBox.appendChild(messageContainer);
                    });
                    // Append username separately if it exists
                    if (guest.username) {
                        const usernameSpan = document.createElement('span');
                        usernameSpan.textContent = ` (${guest.username})`;
                        messageBox.appendChild(usernameSpan);
                    }
                } else {
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = `${guest.name}`;
                    messageBox.appendChild(nameSpan); // Display name only

                    if (guest.username) {
                        const usernameSpan = document.createElement('span');
                        usernameSpan.textContent = ` (${guest.username})`; // Append username if it exists
                        messageBox.appendChild(usernameSpan);
                    }
                }
                listItem.appendChild(messageBox); // Append message box to list item
                guestListItems.appendChild(listItem);
            });

            const newMessageCount = data.length;
            if (newMessageCount > previousMessageCount) {
                playDingSound(); // Play ding sound when new messages arrive
            }
            previousMessageCount = newMessageCount;
        })
        .catch(error => {
            console.error('Error fetching guest list:', error.message);
        });
}




        function playDingSound() {
            const dingSound = document.getElementById('dingSound');
            dingSound.play();
        }

        // Fetch new messages every 1 second
        function fetchNewMessages() {
            getGuestList();
            setTimeout(fetchNewMessages, 100);
        }

        document.addEventListener('DOMContentLoaded', function () {
            getGuestList();
            fetchNewMessages();

            // Add event listener for Enter key press on input fields
            const sendButton = document.getElementById('sendButton');
            const guestNameInput = document.getElementById('guestName');
            const guestUsernameInput = document.getElementById('guestUsername');

            guestNameInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    sendButton.click(); // Simulate click event on send button
                }
            });

            guestUsernameInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    sendButton.click(); // Simulate click event on send button
                }
            });
        });
    </script>
<script>
const backgroundMusic = document.getElementById('backgroundMusic');
const toggleButton = document.getElementById('toggleButton');

let isMusicPlaying = false;

toggleButton.addEventListener('click', () => {
  if (!isMusicPlaying) {
    backgroundMusic.play();
    toggleButton.textContent = 'pouse musik';
  } else {
    backgroundMusic.pause();
    toggleButton.textContent = 'play musik';
  }
  isMusicPlaying = !isMusicPlaying;
});
    </div>
  </div>

</body>
</html>