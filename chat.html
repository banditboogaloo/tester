<!DOCTYPE html>
<html>
<head>
<title>The Mandrill Chat</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <style>
    body {
      background-image: url('maze.gif');
	  background-repeat: repeat;
      color: #333;
      font-family: Arial, sans-serif;
      background-size: cover;
      margin: 0;
      padding: 20px;
    }

		ul {
			list-style-type: none;
			padding: 0;
			
			margin: 15px 0;
		}
		
		br {}
		
		li {
			list-style-type: none;
			padding: 0;
			
			margin: 15px 0;
		}

    .content {
      max-width: 800px;
      margin: 0 auto;
      background-color: rgba(255, 255, 255, 0.65); /* Adding a semi-transparent white background to the content area */
      padding: 20px;
    }

    h1 {
      color: #555;
      font-size: 24px;
      margin-bottom: 20px;
    }

    p {
      margin-bottom: 10px;
    }

    a {
      color: #007bff;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    #content-overlay {
      none;
    }
  </style>
</head>
<body>
  <div id="content-overlay">
    <div class="content">
      <h1>The Mandrill Chat</h1>
	  <p1>made by our benefactors at <a href="https://whatdidyouexpect.eu/elepikchat/">whatdidyouexpect.eu</a></p1>
		
		
		<audio id="backgroundMusic" loop>
		<source src="https://whatdidyouexpect.eu/elepikchat/fundofesteem.mp3" type="audio/mpeg">
		Your browser does not support the audio element.
		</audio>
		<br>
		<button id="toggleButton">Play Music</button>
        <hr>
		<script>
function setCookie(name, value, days) {
    const date = new Date();
    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
    const expires = "expires=" + date.toUTCString();
    document.cookie = name + "=" + value + ";" + expires + ";path=/";
}

function getCookie(name) {
    const decodedCookie = decodeURIComponent(document.cookie);
    const cookies = decodedCookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
            return cookie.substring(name.length + 1);
        }
    }
    return "";
}

function isUsernameLocked() {
    return !!getCookie('usernameLocked');
}

function addGuest() {
    const nameInput = document.getElementById('guestName');
    const usernameInput = document.getElementById('guestUsername');
    let name = nameInput.value;
    const username = usernameInput.value;

    name = name.replace(/:gaming:/g, '<:gaming:1221235240362573976>');
	name = name.replace(/@bandit/g, '<@686168917365751833>');

    if (!name || !username) {
        alert('Fill in both fields.');
        return;
    }

    fetch('https://chat.fiallaspares.com/api/addGuest', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `name=${encodeURIComponent(name)}&username=${encodeURIComponent(username)}`,
    })
    .then(response => {
        if (response.status === 429) {
            alert('noes... you spammed too much....');
            throw new Error('2 much spam');
        }
        if (!response.ok) {
            throw new Error('Network response was is not ok, cheer him up..');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            console.log(`Message sent with ID: ${data.guestId}`);
            nameInput.value = '';
            nameInput.focus();
            setCookie('usernameLocked', 'true', 30);
            setCookie('lockedUsernameValue', username, 30);
        } else {
            alert('failed 2 add message....');
        }
    })
    .catch(error => {
        console.error('error......', error.message);
        alert('failed to send messagez....');
    });
}


document.addEventListener('DOMContentLoaded', function () {
    const usernameInput = document.getElementById('guestUsername');
    if (isUsernameLocked()) {
        usernameInput.value = getCookie('lockedUsernameValue');
        usernameInput.disabled = true;
    }
});
</script>

		<br>
        <input type="text" id="guestUsername" name="guestUsername" placeholder="cooldude69"><br><br>
        <input type="text" id="guestName" name="guestName" placeholder="watz poppin my doods">
		<br>
        <button id="sendButton" onclick="addGuest()">Send Message</button>
        <div id="guestList">
            <ul id="guestListItems"></ul>
        </div>
    </center>

    <!-- Audio element for ding sound -->
    <audio id="dingSound">
        <source src="https://banditboogaloo.github.io/tester/ding.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

 <script>
        let previousMessageCount = 0;

    function getGuestList() {
        fetch('https://chat.fiallaspares.com/api/getGuests')
            .then(response => response.json())
            .then(data => {
                const guestListItems = document.getElementById('guestListItems');
                guestListItems.innerHTML = '';
           const lastTenMessages = data.slice(-35);

            // Reverse the order of the array to display newest guests first
            lastTenMessages.reverse().forEach(guest => {
                const listItem = document.createElement('li');
                const messageBox = document.createElement('div'); // Create a div for message box
                messageBox.classList.add('message-box'); // Add class for styling

                    // Define replacements for multiple emojis
						const replacements = {
							'<:troll:1221226755004825600>': '<img src="troll.png" style="width: 30px; height: auto; vertical-align: middle;">',
							'<:clueless:1221226320214626407>': '<img src="clueless.png" style="width: 25px; height: auto; vertical-align: middle;">',
							'<:steamsalty:1221228132577579130>': '<img src="steamsalty.png" style="width: 25px; height: auto; vertical-align: middle;">',
							':troll:': '<img src="troll.png" style="width: 30px; height: auto; vertical-align: middle;">',
							':clueless:': '<img src="clueless.png" style="width: 25px; height: auto; vertical-align: middle;">',
							':steamsalty:': '<img src="steamsalty.png" style="width: 25px; height: auto; vertical-align: middle;">',
							'<:gaming:1221235240362573976>': '<img src="kleiner.gif" style="width: 25px; height: auto; vertical-align: middle;">',
							':gaming:': '<img src="kleiner.gif" style="width: 25px; height: auto; vertical-align: middle;">',
							
						};

                    // Replace all occurrences of defined emojis with corresponding images
                    let nameWithImages = guest.name;
                    for (const emoji in replacements) {
                        if (replacements.hasOwnProperty(emoji)) {
                            nameWithImages = nameWithImages.replace(new RegExp(emoji, 'g'), replacements[emoji]);
                        }
                    }

                    messageBox.innerHTML = nameWithImages; // Set inner HTML of message box with replaced text

                    if (guest.username) {
                        const usernameSpan = document.createElement('span');
                        usernameSpan.textContent = ` (${guest.username})`; // Append username if it exists
                        messageBox.appendChild(usernameSpan);
                    }

                    listItem.appendChild(messageBox); // Append message box to list item
                    guestListItems.appendChild(listItem);
                });

                const newMessageCount = data.length;
                if (newMessageCount > previousMessageCount) {
                    playDingSound(); // Play ding sound when new messages arrive
                }
                previousMessageCount = newMessageCount;
            })
            .catch(error => {
                console.error('Error fetching guest list:', error.message);
            });
    }




        function playDingSound() {
            const dingSound = document.getElementById('dingSound');
            dingSound.play();
        }

        // Fetch new messages every 1 second
        function fetchNewMessages() {
            getGuestList();
            setTimeout(fetchNewMessages, 100);
        }

        document.addEventListener('DOMContentLoaded', function () {
            getGuestList();
            fetchNewMessages();

            // Add event listener for Enter key press on input fields
            const sendButton = document.getElementById('sendButton');
            const guestNameInput = document.getElementById('guestName');
            const guestUsernameInput = document.getElementById('guestUsername');

            guestNameInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    sendButton.click(); // Simulate click event on send button
                }
            });

            guestUsernameInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    sendButton.click(); // Simulate click event on send button
                }
            });
        });
    </script>
    </div>
  </div>

</body>
</html>
